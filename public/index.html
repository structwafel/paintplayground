<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Color Grid</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        canvas {
            display: block;
            background-color: grey;
        }
    </style>
</head>

<body>
    <div>
        <h1>WebSocket Color Grid</h1>
        <div id="color-picker">
            <button id="grey">Grey- do not use</button>
            <button id="red">Red</button>
            <button id="breen">Green</button>
            <button id="blue">Blue</button>
            <button id="yellow">Yellow</button>
            <button id="purple">Purple</button>
            <button id="orange">Orange</button>
            <button id="pink">Pink</button>
            <button id="brown">Brown</button>
            <button id="black">Black</button>

        </div>
    </div>
    <canvas id="colorGrid"></canvas>
    <script>
        let selectedColor = 'red';
        const colorMapping = {
            'grey': 0,
            'red': 1,
            'green': 2,
            'blue': 3,
            'yellow': 4,
            'purple': 5,
            'orange': 6,
            'pink': 7,
            'brown': 8,
            'black': 9
        };
        document.getElementById('color-picker').addEventListener('click', function (event) {
            selectedColor = event.target.id;
        });



        const socket = new WebSocket('ws://localhost:3000/ws');
        socket.binaryType = "arraybuffer";
        const canvas = document.getElementById('colorGrid');
        const ctx = canvas.getContext('2d');
        const cellSize = 20;
        const gridWidth = 1000;
        const gridHeight = 1000;
        const colors = new Array(gridWidth * gridHeight).fill('grey');

        canvas.width = 1000;
        canvas.height = 1000;

        let offsetX = 0;
        let offsetY = 0;

        function drawGrid() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const startX = Math.floor(offsetX / cellSize);
            const startY = Math.floor(offsetY / cellSize);
            const endX = Math.min(startX + Math.ceil(canvas.width / cellSize), gridWidth);
            const endY = Math.min(startY + Math.ceil(canvas.height / cellSize), gridHeight);

            for (let y = startY; y < endY; y++) {
                for (let x = startX; x < endX; x++) {
                    const color = colors[y * gridWidth + x];
                    ctx.fillStyle = color;
                    ctx.fillRect((x * cellSize) - offsetX, (y * cellSize) - offsetY, cellSize, cellSize);
                }
            }
        }
        function handleScroll(event) {
            if (event.shiftKey) {
                offsetX = Math.max(0, Math.min(gridWidth * cellSize - canvas.width, offsetX + event.deltaY));
            } else {
                offsetY = Math.max(0, Math.min(gridHeight * cellSize - canvas.height, offsetY + event.deltaY));
            }
            drawGrid();
        }
        function handleClick(event) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left + offsetX;
            const y = event.clientY - rect.top + offsetY;
            const cellX = Math.floor(x / cellSize);
            const cellY = Math.floor(y / cellSize);
            const index = cellY * gridWidth + cellX;

            // Change the color of the clicked cell
            colors[index] = selectedColor; // You can change this to any color or logic you want
            drawGrid();

            // Send the updated color to the server
            const data = new Uint8Array(8);
            const view = new DataView(data.buffer);

            view.setBigUint64(0, BigInt(index << 4) | BigInt(colorMapping[selectedColor]), true); // Assuming 1 corresponds to 'red'
            socket.send(data.buffer);
        }
        canvas.addEventListener('wheel', handleScroll);
        canvas.addEventListener('click', handleClick);

        drawGrid();

        socket.onmessage = function (event) {
            if (event.data instanceof ArrayBuffer) {
                console.log('Received binary message');
                const view = new DataView(event.data);
                const messageType = view.getUint8(0);
                console.log('Received chunk updates');
                // Chunk updates
                for (let i = 0; i < event.data.byteLength; i += 8) {
                    const packedValue = view.getBigUint64(i, true);
                    const index = Number(packedValue >> 4n);
                    const colorNumber = Number(packedValue & 0xFn);
                    const color = colorFromNumber(colorNumber);
                    colors[index] = color;
                }
                drawGrid();
            };
        };

        async function fetchBoard() {
            // Fetch the board data as an ArrayBuffer
            const response = await fetch("http://localhost:3000/board");
            const arrayBuffer = await response.arrayBuffer();

            // Create a DataView to read the binary data
            const view = new DataView(arrayBuffer);

            console.log('Received entire chunk');
            // Entire chunk
            for (let i = 0; i < view.byteLength; i++) {
                const color = colorFromNumber(view.getUint8(i));
                colors[i] = color;
            }
            drawGrid();
        }



        function colorFromNumber(number) {
            switch (number) {
                case 0:
                    return 'grey';
                case 1:
                    return 'red';
                case 2:
                    return 'green';
                case 3:
                    return 'blue';
                case 4:
                    return 'yellow';
                case 5:
                    return 'purple';
                case 6:
                    return 'orange';
                case 7:
                    return 'pink';
                case 8:
                    return 'brown';
                case 9:
                    return 'black';
                default:
                    return 'white';
            }
        }

        // Call the fetchBoard function to load the board data
        fetchBoard();
    </script>
</body>

</html>